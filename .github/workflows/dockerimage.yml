name: Docker Image CI

on:
  push:
    branches: 
      - master

jobs:

  build:

    runs-on: ubuntu-latest
    
    env: 
      TIMESTAMP_TAG: ${date +%F}-$(echo "${GITHUB_SHA}" | cut -c1-6)

    steps:
    - uses: actions/checkout@v1
    - name: Set tag timestamp env
      run: echo ::set-env name=TIMESTAMP::$(date +%F)
    - name: Set tag hash env
      run: echo ::set-env name=SHA::$(echo "${GITHUB_SHA}" | cut -c1-6))
    - name: Docker login
      run: docker login docker.pkg.github.com --username DanHatesNumbers --password ${{ secrets.GITHUB_TOKEN }}
    - name: Docker build
      run: docker build -t danhatesnumbers/kali-docker:latest .
    - name: Docker tag with date
      run: docker tag danhatesnumbers/kali-docker:latest danhatesnumbers/kali-docker:$TIMESTAMP-$SHA
    - name: Publish timestamped docker tag
      run: docker push danhatesnumbers/kali-docker:$TIMESTAMP-$SHA
    - name: Publish latest docker tag
      run: docker push danhatesnumbers/kali-docker:latest
